# Spring Cloud Eureka

Netflix Eureka Github地址:

[Netflix Eureka Github](https://github.com/Netflix/eureka)

Spring Cloud Eureka 是 Spring Cloud Netflix 微服务套件的一部分，基于 Netflix  Eureka  做了二次封装，主要负责完成微服务架构中的服务治理功能，服务治理可以说是微服务架构中最为核心和基础的模块，他主要用来实现各个微服务实例的自动化注册与发现。

- **服务注册**：在服务治理框架中，通常都会构建一个注册中心，每个服务单元向注册中心登记自己提供的服务，将主机（host）与端口号、版本号、通信协议等一些附加信息告知注册中心，注册中心按照服务名分类组织服务清单，服务注册中心还需要以心跳的方式去监控清单中的服务是否可用，若不可用需要从服务清单中剔除，达到排除故障服务的效果。
- **服务发现**：由于在服务治理框架下运行，服务间的调用不再通过指定具体的实例地址来实现，而是通过向服务名发起请求调用实现。服务发现可以在集群的场景下保证服务的可用性。



## Eureka Server 

```yml
spring:
  application:
    name: eureka-server
server:
  port: 7000
eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: false
    fetch-registry: false
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/

```

- `server.port`：为了与后续要进行注册的服务区分，这里将服务注册中心的端口设置为 7000。
- `eureka.client.register-with-eureka`：表示是否将自己注册到 Eureka Server，默认为 true。
- `eureka.client.fetch-registry`：表示是否从 Eureka Server 获取注册信息，默认为 true。
- `eureka.client.service-url.defaultZone`：设置与 Eureka Server 交互的地址，查询服务和注册服务都需要依赖这个地址。默认是 http://localhost:8761/eureka ；多个地址可使用英文逗号（,）分隔。



### Eureka Server集群

注意点：

1.   `register-with-eureka: true `和 `fetch-registry: true`
2. `spring.application.name` 一定要相同



尝试用idea环境下搭建4个 Eureka 集群

0. applciation.yml:

```yml
spring:
  application:
    name: eureka-server
  profiles:
    active: peer0

#server:
#  port: 9000
```

1. applciation-peer0.yml:

```yml
spring:
  application:
    name: eureka-server
server:
  port: 9000
eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:9001/eureka/,http://localhost:9002/eureka/,http://localhost:9003/eureka/

```

2. applciation-peer1.yml：

```yml
spring:
  application:
    name: eureka-server
server:
  port: 9001
eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:9000/eureka/,http://localhost:9002/eureka/,http://localhost:9003/eureka/

```

3. applciation-peer2.yml：

```yml
spring:
  application:
    name: eureka-server
server:
  port: 9002
eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:9000/eureka/,http://localhost:9001/eureka/,http://localhost:9003/eureka/

```

4. applciation-peer3.yml：

```yml
spring:
  application:
    name: eureka-server
server:
  port: 9003
eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:9000/eureka/,http://localhost:9001/eureka/,http://localhost:9002/eureka/
```



IDEA的启动配置相关

![image-20210810001650839](/Users/lmafia/IdeaProjects/spring-mirco-service-technology/spring-mirco-service-technology/docs/注册中心.assets/image-20210810001650839.png)



启动之后的控制页面

![image-20210810001823512](/Users/lmafia/IdeaProjects/spring-mirco-service-technology/spring-mirco-service-technology/docs/注册中心.assets/image-20210810001823512.png)





## Eureka Client

对于已经注册的服务，我们将其分为 Service Provider 和 Service Consumer

一个是服务的调用方，一个是服务的消费方。对于一个微服务来说，这不是一个严格的概念，因为 Consumer 也可以是 Provider 。





## 负载均衡

方式1:

使用 LoadBalancerClient 获取提供方的实例hostname + port

默认是轮训的方式

```java
    @Autowired
    private LoadBalancerClient client;

    @Autowired
    private RestTemplate restTemplate;

    @GetMapping("/hello")
    public String helloWord(@RequestParam("name") String name){
        ServiceInstance instance = client.choose("eureka-provider");
        String url = "http://" + instance.getHost() + ":" + instance.getPort() + "/test/helloWord/?name=" + name+instance.getPort();
        return restTemplate.getForObject(url, String.class);
    }
```

方式2:

使用 RestTemplate 加 @LoadBalance 的方式
Config：
```java
@LoadBalanced
   @Bean("restTemplateLoadBalance")
   public RestTemplate restTemplateLoadBalance() {
       return new RestTemplate();
   }
```
Controller：
```java
@Autowired
private RestTemplate restTemplateLoadBalance;

@GetMapping("/hello2")
public String helloWord2(@RequestParam("name") String name){
    String url = "http://eureka-provider/test/helloWord/?name=" +name;
    return restTemplateLoadBalance.getForObject(url, String.class);
}
```



方式3:

使用Feign的方式

创建remote类

```java
@FeignClient(name = "eureka-provider")
public interface HelloRemote {
    @GetMapping("/test/helloWord/")
    public String helloWord3(@RequestParam("name") String name);
}

```

注入并使用

```java
  @Autowired
  private HelloRemote helloRemote;

  @GetMapping("/hello3")
  public String helloWord3(@RequestParam("name") String name){
      return helloRemote.helloWord3(name);
  }
```

